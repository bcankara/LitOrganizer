{% extends "base.html" %}
{% block title %}LitOrganizer â€” API Settings{% endblock %}

{% block content %}
<div class="space-y-8 animate-stagger">

    <!-- Page Header -->
    <header class="stagger-item">
        <h1 class="font-display text-3xl font-semibold text-navy tracking-tight">API Settings</h1>
        <p class="text-gray-500 mt-1">Configure which metadata APIs to use and provide API keys where required.</p>
    </header>

    <div class="max-w-3xl space-y-6">

        <!-- Free APIs -->
        <div class="card stagger-item">
            <h2 class="card-title">
                <svg class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                Free APIs (No Key Required)
            </h2>
            <div class="space-y-4">

                <!-- Crossref -->
                <div class="api-row">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-navy">Crossref</h3>
                            <p class="text-xs text-gray-400">Primary metadata source for DOI resolution</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="api-crossref-enabled" {% if config.crossref.enabled %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- OpenAlex -->
                <div class="api-row">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-navy">OpenAlex</h3>
                            <p class="text-xs text-gray-400">Rich subject and affiliation data</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="api-openalex-enabled" {% if config.openalex.enabled %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="mt-3">
                        <label class="label">Email (optional, for polite pool)</label>
                        <input type="email" id="api-openalex-email" class="input" value="{{ config.openalex.get('email', '') }}" placeholder="your@email.com">
                    </div>
                </div>

                <!-- DataCite -->
                <div class="api-row">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-navy">DataCite</h3>
                            <p class="text-xs text-gray-400">Dataset and research data DOIs</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="api-datacite-enabled" {% if config.datacite.enabled %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Europe PMC -->
                <div class="api-row">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-navy">Europe PMC</h3>
                            <p class="text-xs text-gray-400">Biomedical and life sciences literature</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="api-europepmc-enabled" {% if config.europepmc.enabled %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Semantic Scholar -->
                <div class="api-row">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-navy">Semantic Scholar</h3>
                            <p class="text-xs text-gray-400">AI-powered academic search</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="api-semantic-enabled" {% if config.semantic_scholar.enabled %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="mt-3">
                        <label class="label">API Key (optional, for higher rate limits)</label>
                        <input type="text" id="api-semantic-key" class="input" value="{{ config.semantic_scholar.get('api_key', '') }}" placeholder="Optional API key">
                    </div>
                </div>

            </div>
        </div>

        <!-- Paid / Key-Required APIs -->
        <div class="card stagger-item">
            <h2 class="card-title">
                <svg class="w-5 h-5 text-warn" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                APIs Requiring Configuration
            </h2>
            <div class="space-y-4">

                <!-- Scopus -->
                <div class="api-row">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-navy">Scopus</h3>
                            <p class="text-xs text-gray-400">Elsevier's abstract and citation database (requires API key)</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="api-scopus-enabled" {% if config.scopus.enabled %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="mt-3">
                        <label class="label">API Key</label>
                        <input type="text" id="api-scopus-key" class="input" value="{{ config.scopus.get('api_key', '') }}" placeholder="Enter Scopus API key">
                    </div>
                </div>

                <!-- Unpaywall -->
                <div class="api-row">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-navy">Unpaywall</h3>
                            <p class="text-xs text-gray-400">Open access availability (requires email)</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="api-unpaywall-enabled" {% if config.unpaywall.enabled %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="mt-3">
                        <label class="label">Email</label>
                        <input type="email" id="api-unpaywall-email" class="input" value="{{ config.unpaywall.get('email', '') }}" placeholder="your@email.com">
                    </div>
                </div>

            </div>
        </div>

        <!-- AI-Powered Extraction -->
        <div class="card stagger-item">
            <h2 class="card-title">
                <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                AI-Powered Extraction
            </h2>
            <div class="space-y-4">

                <!-- Google Gemini -->
                <div class="api-row">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-navy">Google Gemini Flash</h3>
                            <p class="text-xs text-gray-400">AI-powered metadata extraction for PDFs without DOI. Uses Gemini to extract title, authors, and year from PDF content.</p>
                        </div>
                        <label class="toggle">
                            <input type="checkbox" id="api-gemini-enabled" {% if config.gemini.enabled %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="mt-3">
                        <label class="label">API Key</label>
                        <input type="text" id="api-gemini-key" class="input" value="{{ config.gemini.get('api_key', '') }}" placeholder="AIzaSy...">
                        <p class="text-xs text-gray-400 mt-1">Get a free key at <a href="https://aistudio.google.com/apikey" target="_blank" class="text-accent hover:underline">Google AI Studio</a></p>
                    </div>
                </div>

            </div>
        </div>

        <!-- Save Button -->
        <div class="stagger-item">
            <button onclick="saveSettings()" class="btn-primary py-3 px-8 text-base">
                Save Settings
            </button>
            <span id="save-status" class="ml-3 text-sm text-success hidden">Settings saved successfully.</span>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function saveSettings() {
    const config = {
        crossref: {
            enabled: document.getElementById('api-crossref-enabled').checked
        },
        openalex: {
            email: document.getElementById('api-openalex-email').value,
            enabled: document.getElementById('api-openalex-enabled').checked
        },
        datacite: {
            enabled: document.getElementById('api-datacite-enabled').checked
        },
        europepmc: {
            enabled: document.getElementById('api-europepmc-enabled').checked
        },
        scopus: {
            api_key: document.getElementById('api-scopus-key').value,
            enabled: document.getElementById('api-scopus-enabled').checked
        },
        semantic_scholar: {
            api_key: document.getElementById('api-semantic-key').value,
            enabled: document.getElementById('api-semantic-enabled').checked
        },
        unpaywall: {
            email: document.getElementById('api-unpaywall-email').value,
            enabled: document.getElementById('api-unpaywall-enabled').checked
        },
        gemini: {
            api_key: document.getElementById('api-gemini-key').value,
            enabled: document.getElementById('api-gemini-enabled').checked
        }
    };

    fetch('/settings/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
    })
    .then(r => r.json())
    .then(data => {
        const status = document.getElementById('save-status');
        if (data.success) {
            status.textContent = 'Settings saved successfully.';
            status.className = 'ml-3 text-sm text-success';
        } else {
            status.textContent = 'Error: ' + data.message;
            status.className = 'ml-3 text-sm text-danger';
        }
        status.classList.remove('hidden');
        setTimeout(() => status.classList.add('hidden'), 4000);
    })
    .catch(err => {
        const status = document.getElementById('save-status');
        status.textContent = 'Connection error.';
        status.className = 'ml-3 text-sm text-danger';
        status.classList.remove('hidden');
    });
}
</script>
{% endblock %}
